<!DOCTYPE html>
<html>
<head>
    <title>KPA Traffic Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron&family=Rajdhani&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="topbar">
        üõ∞Ô∏è KPA AI TRAFFIC COMMAND
        <div id="live-clock" style="color: #00ff6a; font-family: 'Orbitron'; font-size: 14px;">System Time: --:--:--</div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="section-title">SYSTEM MONITORING</div>
            <div id="user-location-status" style="font-size: 14px; color: #00ffe1; margin-bottom: 10px;">
                üõ∞Ô∏è Initializing GPS...
            </div>

            <div class="section-title">OPTIMAL ROUTE</div>
            <div class="best">{{ best_route }}</div>

            <div class="section-title">INTELLIGENCE REPORT</div>
            <ul class="route-list" style="color: #ffaa00;">
                {% for info in roads[best_route]["explanation"] %}
                    <li>{{ info }}</li>
                {% endfor %}
            </ul>

            <div class="section-title">NAVIGATION STEPS</div>
            <ul class="route-list">
                {% for step in roads[best_route]["directions"] %}
                    <li>{{ step }}</li>
                {% endfor %}
            </ul>

            <div class="section-title">NETWORK STATUS</div>
            {% for name, data in roads.items() %}
                <div class="card {{ data.color }}">
                    <strong>{{ name }}</strong><br>
                    Delay: {{ data.delay }}m | {{ data.density }} Traffic
                </div>
            {% endfor %}
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        /* 1. THE CLOCK SCRIPT */
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-clock').innerText = "System Time: " + now.toLocaleTimeString();
        }, 1000);

        /* 2. THE MAP SCRIPT */
        var map = L.map('map').setView([-1.28, 36.82], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        /* 3. THE GPS SCRIPT (SHOW WHERE YOU ARE NOW) */
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                
                // Add your blue location dot
                L.circleMarker([lat, lng], {
                    radius: 10, color: '#007bff', fillColor: '#007bff', fillOpacity: 0.9
                }).addTo(map).bindPopup("<b>Current location</b>").openPopup();
                
                // Update the text in the sidebar
                document.getElementById('user-location-status').innerText = "üõ∞Ô∏è Signal Locked: " + lat.toFixed(4) + ", " + lng.toFixed(4);
            }, function(error) {
                document.getElementById('user-location-status').innerText = "üõ∞Ô∏è GPS Access Denied";
            });
        }

        /* 4. TRAFFIC DATA MARKERS */
        var roadsData = {{ roads|tojson }};
        for (let name in roadsData) {
            let r = roadsData[name];
            let dotColor = r.color === 'green' ? '#00ff6a' : r.color === 'orange' ? '#ffaa00' : '#ff3b3b';
            L.circleMarker(r.coords, {
                radius: 12, color: dotColor, fillColor: dotColor, fillOpacity: 0.8
            }).addTo(map).bindPopup("<b>" + name + "</b><br>Delay: " + r.delay + " mins");
        }

        // Auto-refresh data
        setTimeout(() => { location.reload(); }, 30000);
    </script>
</body>
</html>